<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>簡易チャット（GitHub Pages + Firebase）</title>
  <style>
    :root{--bg:#f6f7fb;--panel-bg:transparent;--accent:#dfeeff}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,Arial;background:var(--bg)}
    .app{display:flex;height:100vh}
    /* サイドバー */
    .sidebar{width:260px;background:transparent;border-right:0;padding:16px;box-sizing:border-box}
    .sidebar .logo{font-weight:700;margin-bottom:14px}
    .room-list{display:flex;flex-direction:column;gap:8px}
    .room-card{padding:10px;border-radius:8px;background:transparent;cursor:pointer;border:1px solid rgba(0,0,0,0.05)}
    .room-card.active{outline:2px solid rgba(11,95,255,0.12)}
    .room-card .code{font-family:monospace}
    .main{flex:1;padding:16px;box-sizing:border-box;display:flex;flex-direction:column;gap:12px}
    .topbar{display:flex;align-items:center;gap:12px}
    .displayName{margin-left:auto;font-size:14px;color:#333}
    /* ホーム */
    .home-ctrls{display:flex;gap:8px}
    input[type=text]{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    button{padding:10px 12px;border-radius:8px;border:0;background:#0b5fff;color:white;cursor:pointer}
    button.ghost{background:transparent;color:#0b5fff;border:1px solid rgba(11,95,255,0.08)}
    /* チャット画面 */
    .chat-header{display:flex;align-items:center;gap:12px}
    .room-code-box{font-family:monospace;padding:6px 8px;border-radius:6px;background:rgba(17,66,204,0.06)}
    .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{padding:10px;border-radius:8px;max-width:80%;word-break:break-word}
    .msg.self{align-self:flex-end;background:var(--accent);}
    .msg.other{align-self:flex-start;background:var(--accent);}
    .meta{font-size:12px;color:#555;margin-bottom:6px}
    .composer{display:flex;gap:8px}
    .fullwidth{width:100%}
    /* mobile tweaks */
    @media(max-width:720px){
      .sidebar{display:none}
      .app{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar" id="sidebar">
      <div class="logo">簡易チャット</div>
      <div class="small">参加中の会話</div>
      <div id="roomList" class="room-list"></div>
      <hr />
      <div>
        <button id="goHomeBtn" class="ghost fullwidth">ホーム</button>
      </div>
    </div>

    <div class="main">
      <div class="topbar">
        <h2 id="pageTitle">ホーム</h2>
        <div class="displayName">表示名: <span id="displayName"></span></div>
      </div>

      <div id="homeScreen">
        <div class="home-ctrls">
          <button id="createBtn">会話を作成</button>
          <button id="joinToggle" class="ghost">会話に参加</button>
        </div>
        <div id="createResult" style="margin-top:10px"></div>

        <div id="joinForm" style="display:none;margin-top:10px;">
          <input id="joinCode" type="text" placeholder="会話コードを入力（例: A1b2C3）" />
          <button id="joinEnter">参加</button>
        </div>

        <h3 style="margin-top:18px">参加中の会話</h3>
        <div id="homeRoomList" class="room-list"></div>

      </div>

      <div id="chatScreen" style="display:none;flex-direction:column;height:100%">
        <div class="chat-header">
          <div>会話: <span id="roomCode" class="room-code-box"></span></div>
          <div style="margin-left:auto"><button id="leaveBtn" class="ghost">退出</button></div>
        </div>
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="messageInput" type="text" class="fullwidth" placeholder="メッセージを入力" />
          <button id="sendBtn">送信</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // ====== ここをあなたの Firebase 設定に置き換えてください ======
    const firebaseConfig = {
      apiKey: "AIzaSyDnHa5TQ3siXEY2mYN-exh01Qisp6OoCXs",
      authDomain: "easy-online-chat.firebaseapp.com",
      databaseURL: "https://easy-online-chat-default-rtdb.firebaseio.com",
      projectId: "easy-online-chat",
      storageBucket: "easy-online-chat.firebasestorage.app",
      messagingSenderId: "447662079365",
      appId: "1:447662079365:web:4d25292d65c86b5d0698ec"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js'
    import { getDatabase, ref, set, get, child, push, onChildAdded, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js'
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js'

    const app = initializeApp(firebaseConfig)
    const db = getDatabase(app)
    const auth = getAuth()

    // --- DOM ---
    const displayNameEl = document.getElementById('displayName')
    const createBtn = document.getElementById('createBtn')
    const joinToggle = document.getElementById('joinToggle')
    const createResult = document.getElementById('createResult')
    const joinForm = document.getElementById('joinForm')
    const joinCodeInput = document.getElementById('joinCode')
    const joinEnter = document.getElementById('joinEnter')
    const homeScreen = document.getElementById('homeScreen')
    const chatScreen = document.getElementById('chatScreen')
    const roomCodeEl = document.getElementById('roomCode')
    const leaveBtn = document.getElementById('leaveBtn')
    const messagesEl = document.getElementById('messages')
    const messageInput = document.getElementById('messageInput')
    const sendBtn = document.getElementById('sendBtn')
    const roomListEl = document.getElementById('roomList')
    const homeRoomListEl = document.getElementById('homeRoomList')
    const pageTitle = document.getElementById('pageTitle')
    const goHomeBtn = document.getElementById('goHomeBtn')

    // --- ローカル保存 ---
    let myName = localStorage.getItem('chat_name') || ''
    let joinedRooms = JSON.parse(localStorage.getItem('chat_rooms') || '[]')
    function saveRooms(){ localStorage.setItem('chat_rooms', JSON.stringify(joinedRooms)) }
    function addLocalRoom(code){ if(!joinedRooms.includes(code)){ joinedRooms.push(code); saveRooms(); renderRoomLists(); } }
    function removeLocalRoom(code){ joinedRooms = joinedRooms.filter(c=>c!==code); saveRooms(); renderRoomLists(); }

    // --- 認証 ---
    let myUid = null
    signInAnonymously(auth).catch(err=>console.error('anonymous sign-in failed',err))
    onAuthStateChanged(auth, user=>{
      if(user){ myUid = user.uid; initUI(); }
    })

    // --- 名前管理 ---
    async function askNameIfNeeded(){
      if(!myName){
        myName = prompt('表示名を入力してください（サーバーには保存されません）','ゲスト') || 'ゲスト'
        localStorage.setItem('chat_name', myName)
      }
      displayNameEl.textContent = myName
    }

    // --- ヘルパー: 6桁英数字コード生成 ---
    function genCode(len=6){
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
      let s=''
      for(let i=0;i<len;i++) s += chars.charAt(Math.floor(Math.random()*chars.length))
      return s
    }

    // --- UI 初期化 ---
    async function initUI(){
      await askNameIfNeeded()
      renderRoomLists()
    }

    function renderRoomLists(){
      roomListEl.innerHTML = ''
      homeRoomListEl.innerHTML = ''
      joinedRooms.forEach(code=>{
        const card = document.createElement('div')
        card.className = 'room-card'
        card.innerHTML = `<div><strong class=\"code\">${code}</strong></div>`
        card.onclick = ()=> openRoom(code)
        roomListEl.appendChild(card)

        const hcard = card.cloneNode(true)
        const leaveBtnSmall = document.createElement('button')
        leaveBtnSmall.textContent = '退出'
        leaveBtnSmall.className = 'ghost'
        leaveBtnSmall.onclick = (e)=>{ e.stopPropagation(); leaveRoom(code) }
        hcard.appendChild(leaveBtnSmall)
        homeRoomListEl.appendChild(hcard)
      })
    }

    // --- ルーム生成 ---
    async function createRoom(){
      createResult.textContent = '生成中……'
      for(let attempts=0; attempts<6; attempts++){
        const code = genCode(6)
        const roomRef = ref(db, `rooms/${code}`)
        const snap = await get(roomRef)
        if(!snap.exists()){
          // create with participants containing this user (rules expect this)
          const obj = {
            createdAt: Date.now(),
            creator: myName,
            participants: { }
          }
          obj.participants[myUid] = true
          await set(roomRef, obj)
          addLocalRoom(code)
          createResult.innerHTML = `作成しました。コード: <span class=\"codebox\">${code}</span> <button id=\"copyBtn\">コピー</button> <button id=\"openBtn\" class=\"ghost\">開く</button>`
          document.getElementById('copyBtn').onclick = ()=>navigator.clipboard.writeText(code)
          document.getElementById('openBtn').onclick = ()=>openRoom(code)
          return
        }
      }
      createResult.textContent = 'コードの衝突が発生しました。もう一度お試しください。'
    }

    // --- 参加 ---
    async function joinRoomByCode(code){
      if(!code) return alert('コードを入力してください')
      const roomRef = ref(db, `rooms/${code}`)
      const snap = await get(roomRef)
      if(!snap.exists()) return alert('そのコードの会話は存在しません')
      // add ourselves to participants
      const partRef = ref(db, `rooms/${code}/participants/${myUid}`)
      await set(partRef, true)
      addLocalRoom(code)
      openRoom(code)
    }

    // --- Chat ---
    let currentRoom = null
    let childUnsubscribe = null

    function clearMessages(){ messagesEl.innerHTML = '' }
    function appendMessage(msg){
      const div = document.createElement('div')
      div.className = 'msg ' + (msg.sender === myName ? 'self' : 'other')
      const meta = document.createElement('div')
      meta.className = 'meta'
      const t = new Date(msg.ts || Date.now())
      meta.textContent = `${msg.sender} · ${t.toLocaleString()}`
      const text = document.createElement('div')
      text.textContent = msg.text
      div.appendChild(meta)
      div.appendChild(text)
      messagesEl.appendChild(div)
      messagesEl.scrollTop = messagesEl.scrollHeight
    }

    async function openRoom(code){
      currentRoom = code
      roomCodeEl.textContent = code
      pageTitle.textContent = `会話：${code}`
      homeScreen.style.display = 'none'
      chatScreen.style.display = 'flex'
      clearMessages()
      renderRoomLists()

      // detach previous listener is unnecessary with onChildAdded from different ref, but we'll not track explicit off here for simplicity
      const msgsRef = ref(db, `rooms/${code}/messages`)
      // listen existing messages and new ones
      // To get existing messages, we can read once and then attach onChildAdded
      const snap = await get(msgsRef)
      if(snap.exists()){
        const all = snap.val()
        Object.values(all).forEach(m=> appendMessage(m))
      }
      // live listen
      onChildAdded(msgsRef, (snapshot)=>{
        const m = snapshot.val()
        appendMessage(m)
      })
    }

    async function sendMessage(){
      const text = messageInput.value.trim()
      if(!text) return
      if(!currentRoom) return alert('会話に参加していません')
      const msgsRef = ref(db, `rooms/${currentRoom}/messages`)
      await push(msgsRef, {
        sender: myName,
        text: text,
        ts: Date.now()
      })
      messageInput.value = ''
    }

    async function leaveRoom(code){
      if(!code) code = currentRoom
      if(!code) return
      // remove participant from DB
      try{ await remove(ref(db, `rooms/${code}/participants/${myUid}`)) }catch(e){console.error(e)}
      removeLocalRoom(code)
      if(currentRoom === code){
        currentRoom = null
        chatScreen.style.display = 'none'
        homeScreen.style.display = 'block'
        pageTitle.textContent = 'ホーム'
      }
    }

    // --- イベント ---
    createBtn.addEventListener('click', ()=> createRoom())
    joinToggle.addEventListener('click', ()=>{ joinForm.style.display = joinForm.style.display === 'none' ? 'block' : 'none' })
    joinEnter.addEventListener('click', ()=> joinRoomByCode(joinCodeInput.value.trim()))
    leaveBtn.addEventListener('click', ()=> leaveRoom(currentRoom))
    sendBtn.addEventListener('click', sendMessage)
    messageInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMessage() })
    goHomeBtn.addEventListener('click', ()=>{
      currentRoom = null
      chatScreen.style.display = 'none'
      homeScreen.style.display = 'block'
      pageTitle.textContent = 'ホーム'
    })

    // render initial
    renderRoomLists()

  </script>
</body>
</html>
